<?php

if(!defined('MOODLE_INTERNAL')) die ('you cannot use this script this way');

if ($canseeothers){
	if ($groupid = groups_get_course_group($course, true)){
		$targetusers = groups_get_members($groupid);
	
		$userids = array_keys($targetusers);
		if (!in_array($userid, $userids)){
			if (empty($targetusers)){
				redirect($CFG->wwwroot.'/course/report/trainingsessions/index.php?id='.$id.'&amp;userid='.$USER->id);
			} else {
				redirect($CFG->wwwroot.'/course/report/trainingsessions/index.php?id='.$id.'&amp;userid='.$userids[0]);
			}
		}
		
	} else {
	    $targetusers = get_users_by_capability($context, 'moodle/course:view', 'u.id, firstname, lastname', 'lastname');
	}
	
	groups_print_course_menu($course, $CFG->wwwroot.'/course/report/trainingsessions/index.php?id='.$id.'&amp;view=user');
	echo '<br/>';
	echo '<br/>';
}

?>
<form action="#" name="selector" method="get">
<input type="hidden" name="id" value="<?php p($course->id) ?>" />
<input type="hidden" name="fromstart" value="" />
<table width="100%">
<tr>
    <td>
        <?php
            print_string('from');
            echo ' : ';
            print_date_selector('startday', 'startmonth', 'startyear', $from);
        ?>
    </td>
        <?php
        if ($canseeothers){
        	
        	echo '<td>';
	        print_string('user');
            echo ' : ';
            
		    $useroptions = array();
		    if ($targetusers){
		        foreach($targetusers as $user){
		           $useroptions[$user->id] = fullname($user);
		        }
		    }
	        choose_from_menu($useroptions, 'userid', $userid);
	        echo '</td>';
	    }
        ?>
    <td>
        <input type="submit" name="go_btn" value="<?php print_string('update') ?>" />
        &nbsp;<input type="button" name="gostart_btn" value="<?php print_string('updatefromcoursestart', 'report_trainingsessions') ?>" onclick="document.forms['selector'].fromstart.value = 1;document.forms['selector'].submit();" />
    </td>
</tr>
</table>
</form>